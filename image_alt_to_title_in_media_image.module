<?php

/**
 * @file
 * Provides form alters and preprocess hooks for field_media_image.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_field_widget_single_element_form_alter().
 */
function image_alt_to_title_in_media_image_field_widget_single_element_form_alter(array &$element, FormStateInterface $form_state, $context) {
  $field_definition = $context['items']->getFieldDefinition();

  // STRICT CHECK: Only run for the specific media image field.
  // This prevents it from touching Menu Link titles.
  if ($field_definition && $field_definition->getName() === 'field_media_image') {
    $handler = \Drupal::service('image_alt_to_title_in_media_image.form_image_field_handler');
    
    if (method_exists($handler, 'processImageField')) {
      $handler->processImageField($element, $form_state);
    }
    
    if (method_exists($handler, 'afterBuildHideTitle')) {
      $element['#after_build'][] = [$handler, 'afterBuildHideTitle'];
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for media_form.
 */
function image_alt_to_title_in_media_image_form_media_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  // Only target Media Entities.
  $handler = \Drupal::service('image_alt_to_title_in_media_image.form_image_field_handler');
  if (method_exists($handler, 'alterForm')) {
    $handler->alterForm($form, $form_state);
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for media_library_widget_form.
 */
function image_alt_to_title_in_media_image_form_media_library_widget_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $handler = \Drupal::service('image_alt_to_title_in_media_image.form_image_field_handler');
  if (method_exists($handler, 'alterMediaLibraryWidgetForm')) {
    $handler->alterMediaLibraryWidgetForm($form, $form_state);
  }
}

/**
 * Implements hook_preprocess_image().
 */
function image_alt_to_title_in_media_image_preprocess_image(&$variables) {
  if (!empty($variables['attributes']['alt']) && empty($variables['attributes']['title'])) {
    $variables['attributes']['title'] = $variables['attributes']['alt'];
  }
}
